<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Công cụ tạo Payload AES-256-CBC</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-4 sm:p-8">
    <div class="max-w-4xl mx-auto bg-white shadow-2xl rounded-xl p-6 md:p-10 border border-gray-100">

        <h1 class="text-3xl font-extrabold text-gray-900 mb-2 border-b pb-2">
            Công cụ tạo Payload AES-256-CBC
        </h1>
        <p class="text-sm text-gray-500 mb-8">
            Mã hóa chuỗi truy vấn (query string) theo chuẩn AES-256-CBC với PKCS7 padding, sau đó chuyển đổi sang Base64 URL-safe.
        </p>

        <div class="space-y-6">
            
            <div>
                <label for="plaintext" class="block text-sm font-medium text-gray-700 mb-1">
                    Chuỗi truy vấn Plaintext
                </label>
                <input type="text" id="plaintext" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150" value="uid=user_12345&product_id=package_001">
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="key" class="block text-sm font-medium text-gray-700 mb-1">
                        Khóa bí mật (32 ký tự cho AES-256)
                    </label>
                    <input type="text" id="key" placeholder="Nhập khóa bí mật..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150">
                    <p id="key-error" class="text-xs text-red-500 mt-1 hidden">Khóa phải có đúng 32 ký tự.</p>
                </div>

                <div>
                    <label for="iv" class="block text-sm font-medium text-gray-700 mb-1">
                        Vector Khởi tạo (16 ký tự - IV)
                    </label>
                    <input type="text" id="iv" placeholder="Nhập IV..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150">
                    <p id="iv-error" class="text-xs text-red-500 mt-1 hidden">IV phải có đúng 16 ký tự.</p>
                </div>
            </div>

            <button id="encrypt-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transform transition duration-200 hover:scale-[1.01] focus:outline-none focus:ring-4 focus:ring-blue-500/50">
                Tạo Payload Mã hóa
            </button>
        </div>

        <div class="mt-10 pt-6 border-t border-gray-200">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">
                Payload mã hóa Base64 URL-safe
            </h2>
            <div class="relative">
                <textarea id="output" readonly rows="4" class="w-full p-4 pr-16 bg-gray-100 border border-gray-300 rounded-lg font-mono text-gray-700 resize-none" placeholder="Kết quả sẽ hiển thị ở đây sau khi bạn nhập đủ thông tin và nhấn nút Tạo..."></textarea>
                
                <button id="copy-btn" class="absolute top-2 right-2 bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-3 rounded-md transition duration-150 shadow-md disabled:bg-gray-400" disabled>
                    <svg class="w-5 h-5 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h12a2 2 0 002-2v-1M8 5a2 2 0 002 2h4a2 2 0 002-2M8 5a2 2 0 012-2h4a2 2 0 012 2"></path></svg>
                    <span id="copy-text">Sao chép</span>
                </button>
            </div>
            <p id="copy-error-message" class="text-sm text-red-500 mt-2 hidden">Lỗi: Không thể sao chép tự động.</p>
        </div>
    </div>

    <script>
        const plaintextInput = document.getElementById('plaintext');
        const keyInput = document.getElementById('key');
        const ivInput = document.getElementById('iv');
        const outputTextarea = document.getElementById('output');
        const encryptBtn = document.getElementById('encrypt-btn');
        const copyBtn = document.getElementById('copy-btn');
        const copyTextSpan = document.getElementById('copy-text');
        const keyError = document.getElementById('key-error');
        const ivError = document.getElementById('iv-error');
        const copyErrorMessage = document.getElementById('copy-error-message');

        function base64ToUrlSafe(base64) {
            return base64.replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
        }

        function encryptAndEncode() {
            const plaintext = plaintextInput.value;
            const keyString = keyInput.value;
            const ivString = ivInput.value;
            
            keyError.classList.add('hidden');
            ivError.classList.add('hidden');
            copyErrorMessage.classList.add('hidden');

            // Nếu chưa nhập gì thì không làm gì cả (để tránh báo lỗi đỏ lòm khi vừa vào trang)
            if (!keyString && !ivString) {
                 outputTextarea.value = "Vui lòng nhập Key và IV để bắt đầu.";
                 return;
            }

            let isValid = true;
            if (keyString.length !== 32) {
                keyError.classList.remove('hidden');
                isValid = false;
            }
            if (ivString.length !== 16) {
                ivError.classList.remove('hidden');
                isValid = false;
            }

            if (!isValid) {
                outputTextarea.value = "Lỗi: Vui lòng kiểm tra độ dài của Key (32 ký tự) và IV (16 ký tự).";
                copyBtn.disabled = true;
                return;
            }

            try {
                const keyWordArray = CryptoJS.enc.Utf8.parse(keyString);
                const ivWordArray = CryptoJS.enc.Utf8.parse(ivString);

                const encrypted = CryptoJS.AES.encrypt(plaintext, keyWordArray, {
                    iv: ivWordArray,
                    mode: CryptoJS.mode.CBC,
                    padding: CryptoJS.pad.Pkcs7
                });

                const base64Standard = encrypted.ciphertext.toString(CryptoJS.enc.Base64);
                const base64UrlSafe = base64ToUrlSafe(base64Standard);

                outputTextarea.value = base64UrlSafe;
                copyBtn.disabled = false;

            } catch (error) {
                console.error("Lỗi mã hóa:", error);
                outputTextarea.value = "Đã xảy ra lỗi trong quá trình mã hóa.";
                copyBtn.disabled = true;
            }
        }

        encryptBtn.addEventListener('click', encryptAndEncode);

        copyBtn.addEventListener('click', () => {
            const payload = outputTextarea.value;
            if (payload) {
                const tempTextArea = document.createElement('textarea');
                tempTextArea.value = payload;
                document.body.appendChild(tempTextArea);
                tempTextArea.select();
                try {
                    document.execCommand('copy');
                    const originalText = copyTextSpan.textContent;
                    copyTextSpan.textContent = 'Đã sao chép!';
                    copyBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
                    copyBtn.classList.add('bg-blue-500', 'hover:bg-blue-500');
                    setTimeout(() => {
                        copyTextSpan.textContent = originalText;
                        copyBtn.classList.remove('bg-blue-500', 'hover:bg-blue-500');
                        copyBtn.classList.add('bg-green-500', 'hover:bg-green-600');
                    }, 1500);
                } catch (err) {
                    copyErrorMessage.classList.remove('hidden');
                } finally {
                    document.body.removeChild(tempTextArea);
                }
            }
        });

        // ĐÃ SỬA: Xóa dòng window.onload để không tự động chạy khi Key/IV trống
        // window.onload = encryptAndEncode; 
    </script>
</body>
</html>
